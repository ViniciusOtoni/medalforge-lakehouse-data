bundle:
  name: one-data-proccess
  databricks_cli_version: ">=0.220.0"

variables:
  dynamic_spn_client_id:
    description: "Client ID da SPN din칙mica para run_as e permissions"
  cluster_spark_version:
    description: "DBR LTS do job cluster"
    default: "14.3.x-scala2.12"
  node_type_id:
    description: "SKU do node do job cluster"
    default: "Standard_F4"
  tenant_id:
    description: "Azure Tenant ID para DefaultAzureCredential"
  client_secret:
    description: "Client secret da SPN din칙mica para DefaultAzureCredential"

run_as:
  service_principal_name: ${var.dynamic_spn_client_id}

targets:
  dev:
    default: true
    sync:
      include:
        - src/**
        - pyproject.toml
        - contracts/**
      exclude:
        - .git/**
        - .github/**
    
    artifacts:
      onedata_wheel:
        type: whl
        path: .   # raiz onde est치 o pyproject.toml
        build: |-
          python -m pip install --upgrade build
          python -m build --wheel --outdir dist
        files:
          source:
            - dist/onedata-*.whl
   
        

    resources:
      jobs:
        one_data_proccess:
          name: one_data_proccess
          permissions:
            - level: CAN_MANAGE
              service_principal_name: ${var.dynamic_spn_client_id}

          tasks:
            - task_key: bronze_ingest
              python_wheel_task:
                package_name: onedata
                entry_point: bronze_main          
                parameters:
                  - --mode
                  - validate+plan+ingest
                  - --contract_path
                  - ${workspace.file_path}/src/onedata/contracts/bronze/dummy.json
              job_cluster_key: small_job_cluster
              libraries:
                - whl: ./dist/onedata-*.whl 

            - task_key: silver_transform
              depends_on:
                - task_key: bronze_ingest
              python_wheel_task:
                package_name: onedata
                entry_point: silver_main
                parameters:
                  - --contract_path
                  - ${workspace.file_path}/src/onedata/contracts/silver/dummy.yaml
              job_cluster_key: small_job_cluster
              libraries:
                - pypi: { package: "databricks-labs-dqx==0.8.0" }
                - whl: ./dist/onedata-*.whl
                
          job_clusters:
            - job_cluster_key: small_job_cluster
              new_cluster:
                spark_version: ${var.cluster_spark_version}
                node_type_id: ${var.node_type_id}
                autoscale:
                  min_workers: 1
                  max_workers: 1
                azure_attributes:
                  availability: SPOT_WITH_FALLBACK_AZURE
                data_security_mode: SINGLE_USER
                custom_tags:
                  project: one-data
                spark_env_vars:
                  # Auth SPN din칙mica (DefaultAzureCredential usa isso)
                  AZURE_CLIENT_ID: ${var.dynamic_spn_client_id}
                  AZURE_TENANT_ID: ${var.tenant_id}
                  AZURE_CLIENT_SECRET: ${var.client_secret}
                  # Monitoria
                  MON_TABLE_ACCOUNT: medalforgestorage
                  MON_TABLE_NAME: pipelineruns
                  ENV: dev
